stages:
  - build
  - deploy

variables:
  IMAGE_NAME: ${Login_Docker_Hub}/moj-server-dns
  # Login_Docker_Hub i Haslo_Docker_Hub należy ustawić w Settings > CI/CD > Variables


# ============================================
# ETAP 1: Budowanie i wysyłanie obrazu do rejestru Docker Hub
# ============================================
utworzenie-oraz-wyslanie_obrazu:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$Haslo_Docker_Hub" | docker login -u "$Login_Docker_Hub" --password-stdin
  script:
    # Generowanie tagów
    - |
      if [ "$CI_COMMIT_REF_NAME" = "$CI_DEFAULT_BRANCH" ]; then
        LATEST_TAG="${IMAGE_NAME}:latest"
      else
        LATEST_TAG=""
      fi
    - SHA_TAG="${IMAGE_NAME}:sha-${CI_COMMIT_SHORT_SHA}"
    
    # Budowanie obrazu
    - docker build -t "${IMAGE_NAME}:latest" -t "${SHA_TAG}" .
    
    # Wysyłanie na Docker Hub
    - docker push "${IMAGE_NAME}:latest"
    - docker push "${SHA_TAG}"
    
    # Jeśli jest tag Git, wypchnij też z tym tagiem
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag "${IMAGE_NAME}:latest" "${IMAGE_NAME}:${CI_COMMIT_TAG}"
        docker push "${IMAGE_NAME}:${CI_COMMIT_TAG}"
      fi


# ============================================
# ETAP 2: Wdrożenie kontenera na docelowym systemie i testy
# ============================================
deploy-and-test:
  stage: deploy
  needs:
    - utworzenie-oraz-wyslanie_obrazu
  tags:
    - localdnsserver  # Agent ze znacznikiem 'localdnsserver' (self-hosted)
  variables:
    IMAGE_FULL: ${Login_Docker_Hub}/moj-server-dns:latest
  before_script:
    - echo "$Haslo_Docker_Hub" | docker login -u "$Login_Docker_Hub" --password-stdin
  script:
    # Pobranie i ponowne utworzenie kontenera z docker-compose
    - docker compose pull
    - docker compose down
    - docker compose up --force-recreate -d
    
    # Test 1 — named-checkconf
    - docker run --rm --pull always $IMAGE_FULL /bin/bash -c "named-checkconf /etc/bind/named.conf"
    
    # Test 2 — named-checkzone
    - docker run --rm --pull always $IMAGE_FULL /bin/bash -c "named-checkzone adminakademia.lan /etc/bind/db.adminakademia.lan"
