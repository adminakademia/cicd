spec:
  inputs:
    IP_HOSTA:
      description: "Podaj adres IP hosta na który zrealizować wdrożenie strony www"
      default: "0.0.0.0"
    SSH_USER:
      description: "Użytkownik SSH do połączenia z hostem (domyślnie: user)"
      default: "user"

---

stages:
#  - lint
  - deploy

workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
# Powyższe oznacza, że przepływ uruchomi się tylko gdy zostanie wywołany 
# ręcznie z interfejsu webowego GitLaba (przycisk "Run pipeline" w CI/CD → Pipelines)
    - when: never
# Powyższe oznacza, że we wszystkich innych przypadkach 
# (push, merge request, schedule, API, itp.) przepływ nie zostanie uruchomiony.



# =========================
#     ZADANIE: LINT
# =========================
#lint:
#  stage: lint
#  tags:
#    - moj_ansible
#  script:
#    - echo "Sprawdzanie czy ansible-lint jest zainstalowany..."
#    - |
#      if command -v ansible-lint >/dev/null 2>&1; then
#        echo "ansible-lint już jest zainstalowany."
#      else
#        echo "ansible-lint nie jest zainstalowany. Instalowanie..."
#        sudo apt update
#        sudo apt install -y ansible-lint
#      fi
#    - echo "Linting playbooków..."
#    - ansible-lint instalacja_dockernginx_strona.yaml



# =========================
#     ZADANIE: DEPLOY
# =========================
deploy:
  stage: deploy
  tags:
    - moj_ansible
#  needs:
#    - lint

  # Poniżej zabezpieczenie przed wiszącym wdrożeniem (np. zawieszony SSH). 
  # Po 30 minutach zadanie padnie – lepsze to niż nieskończone „running”.
  timeout: 30 minutes
  # Zapobiega kilku równoległym wdrożeniom na ten sam adres IP:
  resource_group: deploy-www-$[[ inputs.IP_HOSTA ]]
  variables:
    IP_HOSTA: $[[ inputs.IP_HOSTA ]]
    SSH_USER: $[[ inputs.SSH_USER ]]
  script:
    # Walidacja adresu IP:
    - echo "Sprawdzam IP_HOSTA=${IP_HOSTA}"
    - |
      if [ -z "${IP_HOSTA}" ]; then
        echo "BŁĄD: IP_HOSTA jest puste."
        exit 1
      fi
    - |
      if [ "${IP_HOSTA}" = "0.0.0.0" ]; then
        echo "BŁĄD: IP_HOSTA nie może być 0.0.0.0."
        exit 1
      fi
    - |
      IP_REGEX='^([0-9]{1,3}\.){3}[0-9]{1,3}$'
      if ! [[ "${IP_HOSTA}" =~ ${IP_REGEX} ]]; then
        echo "BŁĄD: IP_HOSTA nie jest poprawnym adresem IPv4 (zły format)."
        exit 1
      fi
    - |
      IFS='.' read -r o1 o2 o3 o4 <<< "${IP_HOSTA}"
      for o in "$o1" "$o2" "$o3" "$o4"; do
        if [ "$o" -lt 0 ] || [ "$o" -gt 255 ]; then
          echo "BŁĄD: IP_HOSTA zawiera oktet spoza zakresu 0–255: ${o}"
          exit 1
        fi
      done
    - echo "Adres IP_HOSTA jest poprawny."

    # Sprawdzenie, czy Ansible jest dostępny na agencie
    - |
      if ! command -v ansible >/dev/null 2>&1; then
        echo "BŁĄD: Ansible nie jest zainstalowany na runnerze."
        echo "Zainstaluj Ansible na maszynie 'moj_ansible' (np. 'sudo apt install ansible') i uruchom pipeline ponownie."
        exit 1
      fi
    - |
      if ! command -v ansible-playbook >/dev/null 2>&1; then
        echo "BŁĄD: ansible-playbook nie jest dostępny, sprawdź instalację Ansible."
        exit 1
      fi
    - echo "Ansible jest dostępny:"
    - ansible --version

    # Budowa pliku inwentarza dla Ansible
    - echo "Ustawienie pliku inventory"
    - mkdir -p ./inventory
    - |
      cat << EOF > ./inventory/serwery.yaml
      all:
        children:
          servers:
            children:
              serweryweb:
                hosts:
                  docker.adminakademia.lan:
                    ansible_host: ${IP_HOSTA}
                    ansible_connection: ssh
                    ansible_ssh_user: ${SSH_USER}
                    ansible_python_interpreter: /usr/bin/python3.13
      EOF
    - echo "Plik inventory/serwery.yaml:"
    - cat ./inventory/serwery.yaml

    # Test ansible ping do hosta
    - echo "Sprawdzam, czy host jest osiągalny przez Ansible (moduł ping)..."
    - ansible all -i ./inventory/serwery.yaml -m ping

    # Uruchomienie scenariusza Ansible
    - echo "Start ansible-playbook..."
    - ansible-playbook -i ./inventory/serwery.yaml instalacja_dockernginx_strona.yaml
